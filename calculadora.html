<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Ahorro con IA</title>
  <style>
    /* ... Tu CSS permanece igual ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>Descubre Cuánto Tiempo Puedes Ahorrar con IA</h1>
    <label class="checkbox-label">Selecciona una o más tareas:</label>
    <div class="checkbox-group" id="tareas">
      <!-- ... tus tareas ... -->
    </div>

    <div id="resultado"></div>
    <div id="perfil"></div>
    <canvas id="grafico" width="400" height="200" style="display:none;"></canvas>

    <button onclick="calcularAhorro()">Calcular Ahorro</button>
    <button onclick="exportarPDF()">Exportar Resultado como PDF</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let ahorroTotal = 0;
    let perfiles = [];
    let chartInstance = null;
    let resumenText = "";
    let perfilText = "";

    function calcularAhorro() {
      const checks = document.querySelectorAll('#tareas input[type="checkbox"]:checked');
      const resultado = document.getElementById("resultado");
      const perfil = document.getElementById("perfil");

      ahorroTotal = 0;
      perfiles = [];
      resumenText = "";
      perfilText = "";

      if (checks.length === 0) {
        resultado.innerHTML = "";
        perfil.innerHTML = "";
        if(chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
        document.getElementById('grafico').style.display = 'none';
        return;
      }

      let resumenHTML = "";
      let tareas = [];
      let ahorros = [];

      checks.forEach(opt => {
        const [minutos, porcentaje, perfilTipo] = opt.value.split(",");
        const ahorro = (parseInt(minutos) * parseInt(porcentaje)) / 100;
        const ahorro2anios = ahorro * 52 * 2;
        ahorroTotal += ahorro2anios;
        perfiles.push(perfilTipo);
        tareas.push(opt.parentElement.innerText.trim());
        ahorros.push(ahorro2anios);
        resumenHTML += `<li>${opt.parentElement.innerText.trim()}: <strong>${ahorro.toFixed(2)} min/sem</strong>, <strong>${ahorro2anios.toFixed(2)} min/2 años</strong></li>`;
        resumenText += `${opt.parentElement.innerText.trim()}: ${ahorro.toFixed(2)} min/sem, ${ahorro2anios.toFixed(2)} min/2 años\n`;
      });

      resultado.innerHTML = `
        <strong>Ahorro estimado:</strong>
        <ul>${resumenHTML}</ul>
        <p><strong>Total estimado en 2 años:</strong> ${ahorroTotal.toFixed(2)} minutos</p>
      `;

      let desarrollo = {
        "Analítico": "Cursos en Power BI, Excel avanzado, automatización.",
        "Comunicador": "Storytelling, persuasión, liderazgo de equipos.",
        "Productivo": "Notion, metodologías ágiles, gestión personal.",
        "Investigador": "Lectura crítica, síntesis, herramientas de búsqueda."
      };

      const perfilesUnicos = [...new Set(perfiles)];
      perfilText = perfilesUnicos.map(p => `${p}: ${desarrollo[p]}`).join("\n");

      perfil.innerHTML = `
        <strong>Perfiles Detectados:</strong> ${perfilesUnicos.join(", ")}<br><br>
        <strong>Sugerencias:</strong><br>${perfilText.replace(/\n/g, '<br>')}
      `;

      generarGrafico(tareas, ahorros);
    }

    function generarGrafico(labels, data) {
      document.getElementById('grafico').style.display = 'block';
      const ctx = document.getElementById('grafico').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Ahorro en 2 años (minutos)',
            data,
            backgroundColor: 'rgba(75, 192, 192, 0.7)'
          }]
        },
        options: {
          responsive: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function exportarPDF() {
  if (!chartInstance) {
    alert("Por favor, primero calcula el ahorro para generar el gráfico.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  const pageWidth = 210;
  const margin = 15;
  let y = margin;

  // Título
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Resumen de Ahorro con IA", pageWidth / 2, y, { align: 'center' });

  y += 10;

  // Sección: Ahorros
  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text("Ahorros estimados por tarea seleccionada:", margin, y);
  y += 6;

  const resumenLines = doc.splitTextToSize(resumenText, pageWidth - 2 * margin);
  resumenLines.forEach(line => {
    doc.text(line, margin, y);
    y += 5;
  });

  y += 4;

  doc.setFont("helvetica", "bold");
  doc.text(`Total estimado en 2 años: ${ahorroTotal.toFixed(2)} minutos`, margin, y);
  y += 10;

  // Sección: Perfiles
  doc.setFont("helvetica", "bold");
  doc.text("Perfiles Detectados y Sugerencias:", margin, y);
  y += 6;

  doc.setFont("helvetica", "normal");
  const perfilLines = doc.splitTextToSize(perfilText, pageWidth - 2 * margin);
  perfilLines.forEach(line => {
    doc.text(line, margin, y);
    y += 5;
  });

  y += 6;

  // Gráfico
  const canvas = document.getElementById('grafico');
  const imageData = canvas.toDataURL('image/png');

  const imgWidth = pageWidth - 2 * margin;
  const imgHeight = imgWidth * 0.5;

  if (y + imgHeight > 290) {
    doc.addPage();
    y = margin;
  }

  doc.addImage(imageData, 'PNG', margin, y, imgWidth, imgHeight);

  doc.save("ahorro_IA.pdf");
}


    function textJustify(doc, text, x, y, width, lineHeight) {
      const lines = doc.splitTextToSize(text, width);
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (i === lines.length - 1 || line.indexOf(' ') === -1) {
          doc.text(line, x, y);
        } else {
          const words = line.trim().split(/\s+/);
          const gaps = words.length - 1;
          const lineWidth = doc.getTextWidth(line);
          const spaceWidth = (width - lineWidth) / gaps;
          let cursor = x;
          words.forEach((word, idx) => {
            doc.text(word, cursor, y);
            if (idx < gaps) cursor += doc.getTextWidth(word) + spaceWidth;
          });
        }
        y += lineHeight;
      }
      return y;
    }
  </script>
</body>
</html>
